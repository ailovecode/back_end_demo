# 用户权限管理系统

## 架构设计

1. **项目架构设计图**

   ![demo架构图](https://github.com/user-attachments/assets/631cbda9-a4be-421e-a830-e54d78f7a1e0)


2. **项目核心业务流程图**

   ![demo-UML](https://github.com/user-attachments/assets/0d170c91-69a7-4a60-addb-a74603571d8b)


---

## 技术实现

1. **权限校验**

   由于系统涉及用户权限操作，所以要设置用户访问权限校验；因此在登录的时候选择用户的`userId`和`username`，并生成`JWT-Token`；通过请求路径的拦截来校验请求头中携带的`Token`信息，获取用户角色状态。

   执行流程：

   ```
   用户登录 --> 生成Token --> 调用服务 --> 校验Token --> 获得权限
   ```

2. **`RPC`服务调用**

   为了提高微服务之间的调用效率，使用`RPC`服务调用简化操作，提高系统的可扩展性和灵活性。

   **技术选型：**`OpenFeign + Nacos`

   当`user-service`、`permission-service`  和 `logging-service`服务被启动之后，向`Nacos`注册实例；当执行权限调用时，用户服务通过`Feign`客户端调用权限服务接口，实现权限访问。

   执行流程：

   ```
   服务向 Nacos 注册实例 --> 定义Feign客户端 --> 调用远程服务
   ```

3. **`MQ`消息可靠性保障策略**

   系统中需要将用户操作记录成日志，并进行持久化，而为了不影响核心业务逻辑，采用消息队列中间件来实现异步消费`MQ`日志消息，同样能够保障用户操作日志不丢失、不重复。

   **技术选型：**`RocketMQ`

   在用户服务中创建生产者和消费者，生产者在业务执行中获取日志，并发送到`Broker`中供消费者进行消费，消费者通过远程服务调用执行操作日志落库的操作，并设置了失败重试机制。

   执行流程：

   ```
   业务层抓取操作日志 --> 生产者发送日志到Broker --> 消费者读取消息 --> 远程调用日志服务进行日志落库
   ```

4. **分库分表路由逻辑**

   为了解决用户数据量庞大而导致一个数据表的存储压力过大，将用户表进行水平分片分担存储压力，从而能够保障高并发下的数据写入和查询性能。

   **技术选型：**`ShardingSphere-JDBC + MySQL`

   **分片逻辑：**将用户表分为四个相同结构的表，并通过自定义雪花算法生成全局唯一ID，并以`user_id`作为分片依据确保数据分布均匀；通过**哈希取模算法**实现数据表的分散，即`db.users_copy$(user_id % 4)`公式来计算映射到的表。

   **执行流程：**

   ```markdown
   ShardingSphere解析user_id字段 --> 调用哈希算法计算目标表 --> 将请求转发至实际表执行写入或查询
   ```

